variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2"
  WEB: registry.cn-hangzhou.aliyuncs.com/cloud_oj/web
  GATEWAY: registry.cn-hangzhou.aliyuncs.com/cloud_oj/gateway
  REGISTRY: registry.cn-hangzhou.aliyuncs.com/cloud_oj/registry
  FILE_SERVICE: registry.cn-hangzhou.aliyuncs.com/cloud_oj/file-service
  MANAGER_SERVICE: registry.cn-hangzhou.aliyuncs.com/cloud_oj/core-service
  JUDGE_SERVICE: registry.cn-hangzhou.aliyuncs.com/cloud_oj/judge-service
cache:
  key: maven
  paths:
    - .m2
stages:
  - npm-build
  - mvn-package
  - build-images
npm-build:
  only:
    - tags
  image: node:16-alpine
  stage: npm-build
  script:
    - cd web && ls
    - npm install
    - npm run build
    - cd ../ && cp -r web/dist .docker/web/
mvn-package:
  only:
    - tags
  image: ghcr.io/imcloudfloating/maven-aliyun:3.8-openjdk-11
  stage: mvn-package
  script:
    - cd services && mvn -B package '-Dmaven.test.skip=true' --file pom.xml
docker-build:
  only:
    - tags
  stage: build-images
  script:
    - docker -v
    - docker build -t $WEB .docker/web/
    - docker build -t $REGISTRY services/registry/
    - docker build -t $GATEWAY services/gateway/
    - docker build -t $FILE_SERVICE services/file-service/
    - docker build -t $MANAGER_SERVICE services/core-service/
    - docker build -t $JUDGE_SERVICE services/judge-service/
    - docker rmi $(docker images -q -f dangling=true) || true